# 执行层五模块详细设计说明

## 一、总体目标

为执行层五模块提供可直接实现的规格：职责边界、输入/输出语义事件、内部阶段与规则、空间/时间校验、并发与事务、降级/随机介入、SLO与可观测性、越权与污染防护。

显式体现：
- 时间=记忆定位（事件/区间索引）
- 空间=行动判定/遮挡（范围/视线/弹道/掩体/可达性）
- 规则/LLM混合与可重放
- 10万+节点并发支撑

## 二、统一约束（执行层通用）

### 输入事件清单（语义名，不写字段）
- ActionProposal：行动建议事件
- ParsedActionReady：解析行动准备就绪事件
- EntitiesResolved：实体解析完成事件
- SpatialVisibilityComputed：空间可见性计算完成事件
- TimelineAdvanced：时间轴推进事件
- TimeNodeTrigger：时间节点触发事件
- NPCHeartbeat：NPC心跳事件
- ContextAssembled：上下文组装完成事件
- DMStyleChanged：DM风格变更事件

### 输出事件清单（语义名，不写字段）
- ExecutionStarted：执行开始事件
- ExecutionPlanned：执行计划事件
- ExecutionResolved：执行完成事件
- ExecutionFailed：执行失败事件
- StateProjected：状态投影事件
- MemoryAnchored：记忆锚点事件
- SceneUpdated：场景更新事件
- GroupEventEmitted：群体事件发出事件
- ScheduledActionCreated：计划行动创建事件

### 可见性约束
- 引用型上下文，仅可见数据与记忆时间窗
- 进入执行前强制"空间可达性/遮挡/范围/声光传播"校验

### 并发与事务
- 按"场景/会话"分片
- 关键事务边界="执行决策+状态投影+事件持久化"
- 其他阶段最终一致
- 至少一次消息+幂等键（会话ID+序列+内容哈希）

### 降级与随机
- 规则→LLM→骰子→模板
- 记录触发原因、曲线参数、随机种子
- 可重放（规则版本/模型温度/输入摘要/输出哈希）

### SLO基线
- 执行层预算≤900ms（空间计算≤200ms、规则/工具≤400ms、调度≤100ms、事务提交≤200ms）

## 三、场景处理器（Scene Processor）

### 职责
维护三维近似与拓扑房间模型，计算方位/距离/可达性/遮挡/掩体等级，刷新空间索引与可见实体集。

### 输入
- ContextAssembled：上下文组装完成事件
- SpatialVisibilityComputed：空间可见性计算完成事件
- TimelineAdvanced：时间轴推进事件
- ActionProposal：行动建议事件（含目标/轨迹需求）

### 输出
- SceneUpdated：场景更新事件
- VisibilityIndexBuilt：可见性索引构建事件
- SpatialValidated：空间校验完成事件
- CoverMapUpdated：掩体地图更新事件
- PathFeasibleComputed：路径可行性计算事件

### 内部阶段
1. 载入场景图：从数据层加载场景拓扑结构
2. 构建BVH/网格或拓扑图：根据场景复杂度选择合适的数据结构
3. 范围/射程/模板匹配：计算空间范围和射程限制
4. 视线/弹道遮挡：计算视线和弹道遮挡情况
5. 声光衰减：模拟声音和光的传播衰减
6. 可达性/导航：计算路径可达性和导航信息
7. 可见清单产出：生成当前可见实体清单

### 近似等级
- L0包围盒：最粗粒度近似，性能最高
- L1网格：中等粒度近似，平衡性能与精度
- L2射线/体素：最精细近似，精度最高
- 按SLO自适应降级，记录等级

### 并发/事务
- 按场景分片：每个场景独立处理
- 空间索引更新为可中断批处理：支持中断和恢复
- 强一致仅限"位置/索引版本号绑定"的提交

### 失败/降级
- 索引过期→退化为L0/L1：降低近似等级
- 路径失败→给出替代路径或骰子介入：提供备选方案

### SLO与观测
- 空间计算≤200ms：单次空间计算延迟预算
- 输出遮挡命中率：记录遮挡计算的成功率
- 路径成功率：记录路径规划的成功率
- 降级等级分布：记录不同近似等级的使用分布

## 四、行为处理器（Behavior Processor）

### 职责
匹配行为规则，分发到专项工具/智能体，完成前置校验（空间/资源/状态），决策与计划生成。

### 输入
- ActionProposal：行动建议事件
- ParsedActionReady：解析行动准备就绪事件
- EntitiesResolved：实体解析完成事件
- SpatialValidated：空间校验完成事件
- DMStyleChanged：DM风格变更事件

### 输出
- ExecutionPlanned：执行计划事件
- RuleApplicationRecorded：规则应用记录事件
- DiceRollRequested：骰子投掷请求事件
- ToolInvocationRequested：工具调用请求事件
- ExecutionResolved/ExecutionFailed：执行完成/失败事件

### 内部阶段
1. 前置校验：验证空间、资源和状态条件
2. 规则匹配：匹配DC/前置条件/代价规则
3. 工具/模型选择：选择合适的工具或模型
4. 计划与副作用估计：生成执行计划并评估副作用
5. 风险与不确定性评估：评估执行风险和不确定性
6. 提交/回滚策略：确定提交或回滚策略

### 混合策略
- 确定性覆盖→低置信调用LLM补全→仍不足触发骰子
- DC与阈值受DM风格影响：根据DM风格调整判定阈值

### 并发/事务
- 按动作实例并发：每个动作实例独立处理
- 关键写入采用"计划+投影"事务：保证关键操作的一致性
- 重放以动作幂等键去重：支持操作重放和去重

### 失败/降级
- 规则缺失/冲突→LLM：规则不足时使用LLM
- LLM不充分→骰子：LLM不足时使用随机决策
- 仍失败→模板建议：最终降级为模板建议

### SLO与观测
- 规则≤300ms、工具≤400ms：规则和工具处理的延迟预算
- 记录命中规则：记录匹配的规则信息
- 阈值/置信度：记录判定阈值和置信度
- 骰子触发原因与种子：记录随机介入的原因和种子

## 五、时间驱动器（Time Driver）

### 职责
记录行动用时、推进系统/事件时间、管理延迟/定时行动、触发宏观时间节点（组织/群体行为）。

### 输入
- ExecutionResolved：执行完成事件（含用时）
- ScheduledActionCreated：计划行动创建事件
- TimelineAdvanced：时间轴推进事件
- TimeNodeTrigger：时间节点触发事件

### 输出
- DelayExpired：延迟过期事件
- ScheduledActionFired：计划行动触发事件
- TimelineAdvanced：时间轴推进事件
- MemoryAnchored：记忆锚点事件（时间锚点）

### 内部阶段
1. 用时累积：累积行动执行时间
2. 小顶堆/时间轮调度：使用高效数据结构调度时间事件
3. 过期触发：触发过期的时间事件
4. 宏观节点扫描：扫描宏观时间节点
5. 记忆锚点生成：生成记忆锚点（valid_time/record_time/来源事件）

### 并发/事务
- 按会话/场景分片：每个会话或场景独立处理
- 调度出队与状态投影同事务：保证调度和状态更新的一致性
- 其余最终一致：非关键操作允许最终一致

### 失败/降级
- 调度拥塞→批量触发：拥塞时批量处理事件
- 长尾→将执行层降级或切片分发：长尾事件降级或分片处理

### SLO与观测
- 调度≤100ms：时间调度延迟预算
- 导出队列深度：监控调度队列深度
- 触发延迟：记录事件触发延迟
- 锚点生成率：记录记忆锚点生成率

## 六、个体处理器（Individual Processor / NPC Agent）

### 职责
基于距离/逻辑/时间激活单个NPC，生成意图与对话/叙事，驱动个体状态变化。

### 输入
- NPCHeartbeat：NPC心跳事件
- ContextAssembled：上下文组装完成事件
- MemoryAnchored：记忆锚点事件
- DMStyleChanged：DM风格变更事件
- SpatialValidated：空间校验完成事件

### 输出
- NPCIntent：NPC意图事件
- NarrationProduced：叙事生成事件
- StateProjected：状态投影事件
- ExecutionPlanned：执行计划事件（个体行动）

### 内部阶段
1. 激活判定：判定NPC是否需要激活
2. 可见上下文组装：组装NPC可见的上下文信息
3. 动机/目标评估：评估NPC的动机和目标
4. 行动选择：选择行动（规则/LLM/骰子）
5. 语言生成/行动计划：生成对话或行动计划

### 可见性与记忆
- 严格视域与时间窗：限制NPC的感知范围和时间窗
- 个体缓存隔离防污染：隔离不同NPC的缓存
- 历史回放仅引用：历史回放仅使用引用而非复制

### 并发/事务
- 每NPC单线程邮箱：每个NPC使用单线程邮箱处理消息
- 状态投影为事务写：状态投影操作使用事务
- 其余最终一致：非关键操作允许最终一致

### 失败/降级
- 上下文不足→提示补充或骰子：上下文不足时提示补充或使用随机
- 模型长尾→模板：模型处理长尾时使用模板

### SLO与观测
- 个体循环≤200ms：单个NPC处理循环延迟预算
- 记录激活原因：记录NPC激活的原因
- 可见实体数：记录NPC可见的实体数量
- 降级比率：记录降级处理的比例

## 七、群体处理器（Group Processor）

### 职责
生成/调度背景路人、组织与势力的群体事件与动态；与时间节点、场景信号联动。

### 输入
- TimeNodeTrigger：时间节点触发事件
- SceneUpdated：场景更新事件
- ResourceBudgetChanged：资源预算变更事件
- ContextAssembled：上下文组装完成事件（群体级）

### 输出
- GroupEventEmitted：群体事件发出事件
- PopulationSpawned/Despawned：人口生成/消失事件
- StateProjected：状态投影事件

### 内部阶段
1. 群体状态汇总：汇总群体当前状态
2. 阈值/资源门槛：检查阈值和资源门槛
3. 事件模板匹配：匹配群体事件模板
4. 空间/时间约束校验：校验空间和时间约束
5. 群体行动队列化：将群体行动加入队列

### 并发/事务
- 按组织/场景分片：每个组织或场景独立处理
- 群体规模调整与状态投影同事务：保证规模调整和状态更新的一致性
- 其余最终一致：非关键操作允许最终一致

### 失败/降级
- 资源不足→降低强度：资源不足时降低群体活动强度
- 校验失败→改写模板或骰子：校验失败时改写模板或使用随机

### SLO与观测
- 群体决策≤300ms：群体决策延迟预算
- 输出人口曲线：记录人口变化曲线
- 事件吞吐：记录群体事件吞吐量
- 模板命中率：记录事件模板命中率

## 八、接口语义与命名规范

### 事件命名
- 动词过去式+语义名（例：ExecutionResolved、StateProjected、SceneUpdated、MemoryAnchored）
- 统一命名模式：所有事件遵循统一的命名模式
- 语义明确性：事件名称应清晰表达其含义

### 幂等与去重
- 业务ID/序列/哈希三键：使用三键确保唯一性
- 跨模块至少一次：模块间通信保证至少一次语义
- 关键链路近似恰好一次：关键业务链路实现幂等去重

### 上下文引用
- 仅ID与必要片段引用：避免大块文本复制
- 标注可见性/版本态：上下文标注包含可见性和版本信息
- 禁止复制大文本：减少数据传输和存储开销

## 九、空间与时间校验钩子

### 空间
- 范围/射程/施法模板：验证空间范围和施法模板
- 视线/弹道遮挡：计算视线和弹道遮挡
- 掩体等级：计算掩体保护等级
- 路径可达性：验证路径可达性
- 失败返回修正建议或骰子：校验失败时提供修正建议或使用随机

### 时间
- 行动用时累积：累积行动执行时间
- 延迟触发：处理延迟触发事件
- 宏观节点扫描：扫描宏观时间节点
- 每次投影生成记忆锚点并可回放：状态投影时生成记忆锚点

## 十、Neo4j/JSONL映射指引（仅原则）

### 节点
- Scene：场景节点
- Actor：角色节点
- Organization：组织节点
- Item：物品节点
- ActionPlan：行动计划节点
- Execution：执行节点
- Event：事件节点
- MemoryAnchor：记忆锚点节点
- GroupEvent：群体事件节点

### 关系
- LOCATED_IN：位置关系
- OCCURS_AT：发生位置关系
- EMITS：发出关系
- CAUSAL：因果关系
- DERIVES：派生关系
- AFFECTS：影响关系
- REFS_VISIBLE：可见性引用关系
- BELONGS_TO：归属关系
- 携带valid_time/record_time：关系携带时间信息

### 稳定键
- 场景/角色/组织主键稳定：使用稳定的主键
- Execution与Event基于业务键+版本态去重：基于业务键和版本状态去重
- 支持分块导入：支持大数据量分块导入

## 十一、质量与SLO对齐

### 每模块SLO
- 场景处理器：空间计算≤200ms
- 行为处理器：规则≤300ms、工具≤400ms
- 时间驱动器：调度≤100ms
- 个体处理器：个体循环≤200ms
- 群体处理器：群体决策≤300ms
- 执行层总预算≤900ms

### 故障注入点
- 空间索引故障：模拟空间索引故障
- 规则引擎故障：模拟规则引擎故障
- 时间调度故障：模拟时间调度故障
- 个体决策故障：模拟个体决策故障
- 群体协调故障：模拟群体协调故障

### 最小观测指标
- 命中率：规则/LLM/骰子命中率
- 降级率：各模块降级处理比例
- 校验失败率：空间/时间校验失败率
- 重试与死信：重试次数和死信队列情况

### 安全与权限
- 感知隔离强制：强制执行感知隔离
- 越权即拒绝并审计：检测到越权立即拒绝并审计
- 缓存隔离与回放校验：隔离缓存数据并校验回放

## 十二、完成条件

五模块均给出：
- 职责：明确定义各模块的职责边界
- 输入/输出：定义清晰的输入输出语义事件
- 内部阶段：详细描述内部处理阶段
- 空间/时间校验：设计空间和时间校验机制
- 并发/事务：设计并发模型和事务边界
- 降级/随机：定义降级策略和随机介入机制
- SLO/观测：定义性能目标和观测指标
- 含映射指引与统一约束：包含数据映射指引和统一约束

文档为纯文本分点、每点≤两行；术语与既有文档一致；不含字段级定义与代码。