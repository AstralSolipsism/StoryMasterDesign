# 并发模型 + 队列与重试 + 事务与一致性 + 回放与去重策略设计说明

## 1) 并发与分片模型

- 分片维度：会话/场景/角色/组织优先级与落点规则；跨分片消息通过事件总线。
- 邮箱与执行：每分片单线程邮箱；解析/检索/空间校验可并行；执行层无共享状态，读模型可缓存。
- 排序与因果：分片内强顺序；跨分片因果以事件时间戳+序列号+依赖边（CAUSAL）恢复。
- 扩展单元：会话单元按会话ID水平扩展，场景单元按场景ID水平扩展，角色单元按角色ID水平扩展。
- 负载均衡：基于分片键的哈希分布，支持动态重分片；热点分片自动拆分与迁移。
- 资源隔离：不同分片使用独立计算资源池，防止单分片故障影响全局。
- 死锁预防：分片内按固定顺序获取锁，跨分片操作使用超时与重试机制。

## 2) 消息语义与幂等

- 语义：跨模块至少一次，关键链路近似恰好一次（幂等键+去重缓存）。
- 幂等/去重键：会话ID+序号+内容哈希；写路径以业务键+版本态去重；投影写入天然幂等。
- 去重缓存：基于Redis的分布式去重缓存，TTL为操作窗口期的2倍；支持批量去重检查。
- 消息版本：每条消息携带单调递增版本号，用于冲突检测与解决。
- 因果追踪：使用因果向量跟踪跨分片消息依赖关系，确保事件处理顺序。
- 幂等范围：状态变更操作全幂等，查询操作仅缓存去重，通知操作允许重复。

## 3) 队列、重试与背压

- 队列类型：即发队列（交互路径）与延时队列（时间驱动）；优先级队列支持抢占。
- 重试：指数退避+抖动；上限N次→死信；幂等键贯穿重试链路。
- 背压与限流：分片级与全局级阈值；排队超限→降级（规则/模板）或丢弃非关键请求。
- 队列分层：热队列（内存）、温队列（SSD）、冷队列（对象存储）；按访问模式自动分层。
- 优先级调度：关键操作高优先级，维护操作低优先级；支持优先级动态调整。
- 流量整形：基于令牌桶的流量控制，防止突发流量冲击系统。
- 队列监控：实时监控队列深度、停留时间、处理速率，自动触发扩缩容。

## 4) 失败补偿与Saga

- 事务模式：事件源化写+读模型投影；跨模块使用Saga编排补偿。
- 补偿触发：部分失败/超时/冲突；补偿动作不可再引入竞态（幂等键隔离）。
- 补偿策略：自动补偿（可逆操作）与人工补偿（复杂决策）；补偿操作记录完整审计日志。
- Saga协调：集中式协调器管理长事务状态，支持超时自动补偿。
- 补偿隔离：补偿操作使用独立资源池，避免与正常操作竞争资源。
- 补偿重试：补偿失败时采用指数退避重试，最终进入人工审核队列。

## 5) 事务边界与一致性

- 强一致边界：状态迁移+事件持久化同事务；空间/时间校验结果与版本号绑定提交。
- 最终一致：解析结果、检索缓存、聚合投影；回放校正与再投影机制。
- 事务粒度：细粒度事务（单操作）与粗粒度事务（业务流程）结合使用。
- 隔离级别：读已提交为默认，关键操作使用可串行化；支持动态调整隔离级别。
- 分布式事务：跨分片操作使用两阶段提交，优化为三阶段提交减少阻塞。
- 一致性检查：定期校验投影与事件源一致性，自动修复不一致数据。

## 6) 时间与空间的消息钩子

- 时间：用时与调度（时间轮/小顶堆）生成DelayExpired/ScheduledActionFired；记忆锚点随事务提交。
- 空间：SceneUpdated/SpatialValidated 携带空间索引版本；路径/遮挡失败→策略降级或骰子。
- 时间锚点：每个事务提交生成记忆锚点，包含valid_time与record_time双时态信息。
- 空间快照：空间变更时生成增量快照，支持空间状态回滚与重建。
- 时空联动：空间变更触发时间事件，时间推进影响空间状态计算。
- 时钟同步：使用混合逻辑时钟（HLC）保证分布式环境下时间顺序一致性。

## 7) 死信处理与隔离

- DLQ：按分片+错误码分桶；毒性消息自动隔离；人工/自动回收通道。
- 隔离级：上下文污染疑虑→只读回放区；越权→拒绝并审计。
- 毒性检测：连续失败N次的消息自动标记为毒性，进入特殊隔离队列。
- 死信分析：定期分析死信模式，识别系统性问题并自动修复。
- 回收策略：简单错误自动回收，复杂错误人工审核，安全相关错误强制人工。
- 隔离策略：按错误类型与影响范围分级隔离，防止问题扩散。

## 8) 观测与SLO

- SLO：P95 路由≤150ms、解析≤600ms、状态迁移≤100ms、执行层≤900ms；队列等待P95≤200ms。
- 指标：队列深度/停留时间/重试率/死信率/近似恰好一次命中率/去重命中率/背压触发数/降级率。
- 分布式追踪：全链路追踪ID贯穿所有操作，支持请求路径重建与性能分析。
- 实时告警：基于SLO的实时告警，支持多级告警与自动恢复。
- 性能基线：建立操作性能基线，自动检测性能回归与异常。
- 容量规划：基于历史指标预测容量需求，提前触发扩容操作。

## 9) 容量规划与扩展

- 目标：稳态≥3k events/s（可配），突发≥10k events/min；分片上限与自动扩缩容策略。
- 存储：事件留存周期、归档与压缩；热/温/冷分层对回放影响与SLO边界。
- 水平扩展：基于负载自动增加分片数量，支持在线重分片操作。
- 垂直扩展：关键路径支持资源动态调整，非关键路径使用弹性资源。
- 弹性策略：预测性扩容（基于历史模式）与反应性扩容（基于实时负载）结合。
- 成本优化：不同优先级操作使用不同成本资源，自动优化资源使用效率。

## 10) 安全与公平性

- 权限：队列级ACL；系统层变更（DMStyle/DicePolicy）需签名与审计。
- 公平：分片公平调度与饥饿保护；优先级仅在SLO内生效。
- 访问控制：基于RBAC与ABAC的细粒度访问控制，支持动态权限调整。
- 审计追踪：所有敏感操作记录完整审计日志，支持不可篡改存储。
- 资源配额：按用户/组织设置资源使用配额，防止资源滥用。
- 公平调度：加权公平队列（WFQ）算法，确保各分片获得公平资源分配。

## 11) 回放与再投影

- 回放策略：按时间/会话/场景回放；再投影校验与差异合并；固定种子保证一致性。
- 回放隔离：只读影子索引；验证通过后热切换。
- 增量回放：支持从任意时间点开始的增量回放，减少全量回放开销。
- 并行回放：多线程并行回放历史事件，提高回放速度。
- 一致性验证：回放过程中实时校验状态一致性，发现偏差自动报警。
- 回放缓存：常用回放结果缓存，减少重复回放计算开销。

## 12) 与Neo4j JSONL的映射原则

- 节点：Event、QueueEnqueue、QueueDequeue、RetryAttempt、DeadLetter、Compensation、BackpressureEvent。
- 关系：EMITS/CAUSAL/RETRIES/DEAD_LETTERED/COMPENSATES/APPLIES_TO(Segment/Scene/Session)；携带valid_time/record_time。
- 去重：稳定业务键+版本态；导入分块；分片键映射为标签/属性以便查询。
- 事件溯源：所有状态变更记录为Event节点，支持完整状态重建。
- 批量导入：JSONL分块批量导入，支持断点续传与错误恢复。
- 查询优化：基于访问模式设计索引策略，优化常用查询性能。

## 13) 与既有文档对齐点

- 与执行层五模块详细设计说明的事务边界一致；与数据层本体与版本化权限策略设计的双时态与可见性一致。
- 与DM风格与骰子介入参数体系设计的降级与随机接入一致；与智能体路由与状态机路由解析管线设计的消息语义一致。
- 与系统设计原则与关键约束的并发模型一致；与系统分层与模块边界说明的模块交互一致。
- 事件溯源与投影模式与数据层设计保持一致；空间/时间校验与执行层设计保持一致。
- 幂等键设计与路由层设计保持一致；失败处理策略与系统设计原则保持一致。

## 14) 质量门槛与验收

- 近似恰好一次命中率≥99.9%；重试成功率≥99%；死信率≤0.1%；回放一致率≥99.9%。
- 提供开放问题清单（阈值默认、扩缩容策略、回放窗口、DLQ保留周期、优先级抢占细则）。
- 性能测试：全链路压力测试验证SLO达标；故障注入测试验证系统韧性。
- 一致性测试：并发场景下数据一致性验证；网络分区场景下系统行为验证。
- 恢复测试：各种故障场景下的恢复能力验证；数据损坏场景下的修复能力验证。
- 安全测试：越权访问测试与防护验证；数据泄露风险评估与防护验证。

## 15) 开放问题清单

- 阈值默认：重试次数上限、退避算法参数、背压触发阈值需基于实际运行数据调优。
- 扩缩容策略：自动扩缩容触发条件、扩缩容步长、冷却时间参数需进一步细化。
- 回放窗口：历史数据保留周期、回放时间范围限制、回放资源配额需明确。
- DLQ保留周期：死信队列数据保留时间、归档策略、清理规则需定义。
- 优先级抢占细则：高优先级任务抢占条件、抢占补偿机制、公平性保障需细化。
- 分片重平衡策略：数据迁移策略、重平衡触发条件、迁移过程一致性保证需设计。
- 跨区域一致性：多区域部署下的一致性策略、延迟容忍度、故障转移机制需明确。
- 监控指标阈值：各项监控指标的告警阈值、自动恢复触发条件、人工介入条件需定义。