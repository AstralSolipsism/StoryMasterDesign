# 系统分层与模块边界说明

## 1) 接入与会话层

### 职责与边界
- 负责用户接入、会话管理与协议适配
- 处理多端接入统一化与身份认证
- 维护会话状态与生命周期管理

### 核心模块
- 接入网关：协议转换与流量控制
- 会话管理器：会话状态维护与超时处理
- 身份认证：多因子认证与权限令牌管理

### 输入输出语义
- 输入：用户请求、认证令牌、会话ID
- 输出：标准化请求、会话上下文、认证结果

### 并发与事务
- 按会话ID分片处理，保证会话内有序
- 会话状态强一致性，跨会话最终一致

### 失败与降级
- 会话中断自动恢复，超时自动清理
- 认证失败降级为只读模式

### SLO
- 延迟预算：接入<100ms，会话操作<50ms
- 并发：支持10万+并发会话

## 2) 路由与编排层

### 智能体路由模块
- 职责：意图识别与智能体分发，上下文聚合与决策
- 输入：用户意图、会话上下文、历史交互
- 输出：路由决策、智能体分配、聚合上下文
- 状态：路由规则缓存、意图模型版本
- 依赖：解析层、上下文层、策略中心
- 并发：按会话隔离，路由决策幂等
- 失败降级：智能体不可用时降级为确定性规则路由
- 可见性：记录路由决策原因与替代方案
- SLO：路由延迟<200ms，决策准确率>95%

### 状态机路由模块
- 职责：状态转换管理与事件触发，状态一致性保证
- 输入：状态变更事件、转换条件、触发器配置
- 输出：状态转换结果、触发事件序列、状态快照
- 状态：状态机定义、当前状态集合、转换历史
- 依赖：事件溯源、数据层角色仓
- 并发：按角色/场景隔离，状态转换串行化
- 失败降级：状态冲突时回滚到上一稳定状态
- 可见性：状态转换全记录，支持回放验证
- SLO：状态转换<100ms，一致性延迟<500ms

### 上下文合并器
- 职责：多源上下文聚合与冲突解决，上下文版本管理
- 输入：多模块上下文片段、合并策略、优先级规则
- 输出：统一上下文视图、冲突解决记录、版本标识
- 状态：上下文缓存、合并规则配置、冲突解决历史
- 依赖：所有下游模块上下文输出
- 并发：按会话隔离，合并操作幂等
- 失败降级：冲突无法解决时保留多版本并标记
- 可见性：记录合并决策过程与冲突解决依据
- SLO：上下文合并<300ms，冲突解决率>90%

## 3) 解析与抽取层

### 信息分类与拆分模块
- 职责：输入信息分类与结构化拆分，确定性规则处理
- 输入：原始用户输入、分类规则、拆分模板
- 输出：结构化信息片段、分类标签、拆分元数据
- 状态：分类规则缓存、拆分模板版本、处理历史
- 依赖：接入层、规则引擎
- 并发：按请求隔离，处理操作幂等
- 失败降级：规则失效时降级为LLM分类
- 可见性：记录分类决策依据与拆分逻辑
- SLO：信息分类<150ms，拆分准确率>92%

### 实体发掘模块
- 职责：文本中实体识别与抽取，实体关系初步建立
- 输入：结构化文本片段、实体库、识别规则
- 输出：实体集合、实体属性、初步关系
- 状态：实体模型版本、识别规则缓存、实体库索引
- 依赖：信息分类模块、数据层设定仓
- 并发：按文本批次隔离，实体识别幂等
- 失败降级：识别失败时保留原始文本标记
- 可见性：记录实体识别置信度与依据
- SLO：实体抽取<200ms，识别准确率>88%

### 关系识别模块
- 职责：实体间关系识别与强度评估，关系图构建
- 输入：实体集合、上下文信息、关系规则
- 输出：关系图、关系强度、关系类型标签
- 状态：关系模型版本、关系规则缓存、关系索引
- 依赖：实体发掘模块、图检索引擎
- 并发：按实体集合隔离，关系识别幂等
- 失败降级：关系模糊时标记为待人工确认
- 可见性：记录关系识别依据与置信度
- SLO：关系识别<250ms，关系准确率>85%

### 检索适配器
- 职责：解析结果标准化与检索适配，混合策略协调
- 输入：解析结果、检索需求、适配规则
- 输出：标准化检索请求、检索策略、优先级
- 状态：适配规则缓存、检索策略配置、适配历史
- 依赖：所有解析模块、检索与上下文层
- 并发：按检索请求隔离，适配操作幂等
- 失败降级：适配失败时使用默认检索策略
- 可见性：记录适配决策过程与策略选择
- SLO：检索适配<100ms，适配成功率>98%

## 4) 检索与上下文层

### 感知裁剪器模块
- 职责：基于角色感知范围的信息裁剪，可见性控制
- 输入：完整信息集、角色感知属性、裁剪规则
- 输出：裁剪后信息集、感知范围边界、遮挡标记
- 状态：感知规则缓存、角色属性版本、裁剪历史
- 依赖：数据层角色仓、空间引擎
- 并发：按角色隔离，裁剪操作幂等
- 失败降级：裁剪失败时降级为最小可见集
- 可见性：记录裁剪决策与遮挡原因
- SLO：感知裁剪<150ms，裁剪准确率>95%

### 记忆索引与回放模块
- 职责：记忆事件索引与时间定位，记忆回放与重建
- 输入：记忆查询条件、时间区间、回放请求
- 输出：记忆事件序列、时间定位结果、回放状态
- 状态：记忆索引、时间轴版本、回放缓存
- 依赖：事件溯源、数据层剧情仓
- 并发：按时间区间隔离，回放操作幂等
- 失败降级：索引损坏时重建索引，回放失败时跳过损坏段
- 可见性：记录记忆访问与回放操作日志
- SLO：记忆检索<200ms，回放延迟<500ms

### 图检索引擎
- 职责：Neo4j图数据检索与关系遍历，图查询优化
- 输入：图查询条件、遍历深度、检索约束
- 输出：图节点集合、关系路径、检索统计
- 状态：查询缓存、索引版本、检索历史
- 依赖：Neo4j图库、数据层
- 并发：按查询隔离，检索操作幂等
- 失败降级：图查询失败时降级为文本检索
- 可见性：记录图查询计划与性能指标
- SLO：图检索<300ms，查询准确率>98%

### 引用型上下文装配器
- 职责：引用型上下文组装与数据去重，上下文压缩
- 输入：上下文片段引用、装配规则、压缩策略
- 输出：装配后上下文、引用映射、压缩比
- 状态：上下文缓存、装配规则版本、压缩历史
- 依赖：所有检索模块、数据层
- 并发：按上下文会话隔离，装配操作幂等
- 失败降级：装配失败时保留原始引用列表
- 可见性：记录装配决策与压缩效果
- SLO：上下文装配<250ms，压缩率>30%

## 5) 执行层

### 场景处理器模块
- 职责：场景级事件处理与状态管理，场景生命周期控制
- 输入：场景事件、处理规则、场景状态
- 输出：场景状态变更、触发事件、处理结果
- 状态：场景状态机、处理规则缓存、场景历史
- 依赖：上下文层、状态机路由、数据层世界仓
- 并发：按场景隔离，处理操作幂等
- 失败降级：场景崩溃时回滚到上一检查点
- 可见性：记录场景处理全链路与状态变更
- SLO：场景处理<500ms，状态一致性>99%

### 行为处理器模块
- 职责：角色行为执行与结果评估，行为链编排
- 输入：行为请求、执行参数、约束条件
- 输出：行为结果、状态变更、影响评估
- 状态：行为模板库、执行历史、效果缓存
- 依赖：上下文层、个体处理器、空间引擎
- 并发：按角色隔离，行为执行幂等
- 失败降级：行为失败时自动补偿或回滚
- 可见性：记录行为执行过程与效果评估
- SLO：行为处理<400ms，执行成功率>95%

### 时间驱动器模块
- 职责：时间事件调度与延迟行动管理，时间轴推进
- 输入：时间事件、调度规则、延迟行动
- 输出：触发事件序列、时间轴状态、调度结果
- 状态：时间调度器、事件队列、时间轴版本
- 依赖：记忆索引与回放、事件溯源
- 并发：按时间区间隔离，调度操作幂等
- 失败降级：调度失败时重试或降级为即时处理
- 可见性：记录时间事件调度与时间轴变更
- SLO：时间调度<100ms，时间轴一致性>99.9%

### 个体处理器模块
- 职责：NPC Agent个体行为决策与执行，个体状态管理
- 输入：个体感知、行为触发、决策参数
- 输出：个体行为、状态变更、决策日志
- 状态：个体状态机、决策模型版本、行为历史
- 依赖：感知裁剪器、行为处理器、骰子判定引擎
- 并发：按个体隔离，决策执行幂等
- 失败降级：决策失败时使用规则化行为
- 可见性：记录个体决策过程与行为执行
- SLO：个体处理<300ms，决策响应率>98%

### 群体处理器模块
- 职责：群体行为协调与组织管理，群体状态同步
- 输入：群体事件、协调规则、组织结构
- 输出：群体行为、状态同步、协调结果
- 状态：群体结构、协调规则版本、群体历史
- 依赖：个体处理器、场景处理器、数据层角色仓
- 并发：按群体隔离，协调操作幂等
- 失败降级：协调失败时降级为个体独立行为
- 可见性：记录群体协调过程与状态同步
- SLO：群体处理<600ms，协调成功率>90%

## 6) 系统策略层

### 骰子判定引擎模块
- 职责：随机事件判定与概率计算，骰子参数管理
- 输入：判定请求、骰子参数、随机种子
- 输出：判定结果、随机值、判定日志
- 状态：骰子配置、随机源状态、判定历史
- 依赖：策略中心、随机源
- 并发：按判定请求隔离，判定操作幂等
- 失败降级：随机源故障时使用确定性替代
- 可见性：记录判定过程与随机值生成
- SLO：骰子判定<50ms，判定准确率>99.9%

### DM风格参数服务模块
- 职责：DM风格参数管理与应用，难度与叙事平衡
- 输入：参数查询、风格配置、平衡规则
- 输出：参数值、风格调整、平衡建议
- 状态：参数配置、风格模型版本、应用历史
- 依赖：策略中心、数据层设定仓
- 并发：按参数集隔离，查询操作幂等
- 失败降级：参数缺失时使用默认风格配置
- 可见性：记录参数应用与风格调整过程
- SLO：参数服务<100ms，配置一致性>99%

### 策略中心模块
- 职责：全局策略管理与规则配置，策略版本控制
- 输入：策略查询、配置更新、版本请求
- 输出：策略规则、配置结果、版本信息
- 状态：策略库、配置版本、更新历史
- 依赖：数据层设定仓、观测与治理层
- 并发：按策略域隔离，配置操作事务化
- 失败降级：策略冲突时回滚到上一稳定版本
- 可见性：记录策略变更与配置应用过程
- SLO：策略查询<50ms，配置一致性>99.9%

### 随机源模块
- 职责：可插拔随机数生成与种子管理，确定性保证
- 输入：随机请求、种子参数、质量要求
- 输出：随机数序列、种子状态、质量报告
- 状态：随机生成器、种子池、质量统计
- 依赖：基础设施层
- 并发：按种子域隔离，生成操作幂等
- 失败降级：随机源故障时使用备用生成器
- 可见性：记录随机数生成与种子使用
- SLO：随机生成<10ms，随机性质量>99%

## 7) 数据与存储层

### 角色数据仓模块
- 职责：角色数据实时版本化管理，角色状态存储
- 输入：角色数据、版本标记、存储请求
- 输出：存储确认、版本信息、数据索引
- 状态：角色数据版本、实时索引、存储统计
- 依赖：Neo4j图库、缓存系统
- 并发：按角色ID分片，写入操作事务化
- 失败降级：写入失败时暂存缓存重试
- 可见性：记录数据变更与版本管理过程
- SLO：数据读写<100ms，版本一致性>99.9%

### 世界数据仓模块
- 职责：世界数据延迟版本化管理，世界状态存储
- 输入：世界数据、版本标记、存储请求
- 输出：存储确认、版本信息、数据索引
- 状态：世界数据版本、延迟索引、存储统计
- 依赖：Neo4j图库、对象存储
- 并发：按世界区域分片，批量写入优化
- 失败降级：写入失败时降级为最终一致
- 可见性：记录数据变更与版本管理过程
- SLO：数据读写<200ms，最终一致延迟<5s

### 剧情数据仓模块
- 职责：剧情事件存储与时间索引，剧情状态管理
- 输入：剧情事件、时间标记、存储请求
- 输出：存储确认、时间索引、事件关联
- 状态：剧情事件库、时间轴索引、关联图谱
- 依赖：事件溯源、Neo4j图库
- 并发：按时间区间分片，事件存储有序
- 失败降级：存储失败时暂存队列重试
- 可见性：记录事件存储与索引构建过程
- SLO：事件存储<150ms，时间索引准确率>99%

### 设定数据仓模块
- 职责：设定规则存储与版本管理，设定配置服务
- 输入：设定规则、版本标记、配置请求
- 输出：存储确认、版本信息、配置数据
- 状态：设定规则库、配置版本、应用统计
- 依赖：Neo4j图库、缓存系统
- 并发：按设定域隔离，配置变更事务化
- 失败降级：配置失败时回滚到上一版本
- 可见性：记录设定变更与配置应用过程
- SLO：设定查询<50ms，配置一致性>99.9%

### 图库管理模块
- 职责：Neo4j图数据管理与维护，图结构优化
- 输入：图数据、结构变更、维护请求
- 输出：操作确认、结构信息、性能报告
- 状态：图结构版本、索引配置、性能统计
- 依赖：基础设施层
- 并发：按图分区隔离，结构变更事务化
- 失败降级：操作失败时回滚到上一稳定状态
- 可见性：记录图操作与性能优化过程
- SLO：图操作<300ms，结构一致性>99.9%

### 时空索引模块
- 职责：时间与空间索引管理，时空查询优化
- 输入：时空数据、索引请求、查询条件
- 输出：索引确认、查询结果、性能报告
- 状态：时空索引、查询缓存、性能统计
- 依赖：空间引擎、时间调度器
- 并发：按时空区域分片，查询操作幂等
- 失败降级：索引故障时降级为全表扫描
- 可见性：记录索引构建与查询优化过程
- SLO：索引构建<500ms，查询响应<200ms

### 缓存系统模块
- 职责：多级缓存管理与数据一致性保证，缓存策略优化
- 输入：缓存数据、策略配置、一致性请求
- 输出：缓存确认、策略结果、一致性报告
- 状态：缓存层级、策略配置、一致性状态
- 依赖：所有数据仓模块
- 并发：按缓存键分片，操作原子化
- 失败降级：缓存故障时直连数据源
- 可见性：记录缓存操作与一致性保证过程
- SLO：缓存读写<20ms，命中率>85%

## 8) 观测与治理层

### 审计模块
- 职责：全链路审计日志记录与审计分析，合规性保证
- 输入：审计事件、日志数据、分析请求
- 输出：审计日志、分析报告、合规评估
- 状态：审计日志库、分析规则、合规状态
- 依赖：所有业务模块、事件溯源
- 并发：按审计流隔离，记录操作异步化
- 失败降级：记录失败时暂存本地后补传
- 可见性：审计日志本身不可篡改
- SLO：审计记录<50ms，日志完整性>99.9%

### 事件溯源模块
- 职责：事件流存储与事件重建，事件版本管理
- 输入：事件流、版本标记、重建请求
- 输出：存储确认、事件重建、版本信息
- 状态：事件流存储、重建状态、版本历史
- 依赖：剧情数据仓、审计模块
- 并发：按事件流隔离，存储操作有序
- 失败降级：重建失败时跳过损坏事件段
- 可见性：记录事件存储与重建过程
- SLO：事件存储<100ms，重建准确率>99%

### 指标追踪模块
- 职责：业务指标收集与分析，性能指标监控
- 输入：指标数据、分析规则、监控请求
- 输出：指标报告、分析结果、告警信息
- 状态：指标库、分析模型、监控状态
- 依赖：所有业务模块
- 并发：按指标域隔离，收集操作异步化
- 失败降级：收集失败时估算指标值
- 可见性：记录指标收集与分析过程
- SLO：指标收集<20ms，分析准确率>95%

### 权限与越权检测模块
- 职责：权限管理与越权访问检测，安全策略执行
- 输入：访问请求、权限策略、检测规则
- 输出：权限决策、检测结果、阻断记录
- 状态：权限库、策略版本、检测历史
- 依赖：身份认证、所有数据访问模块
- 并发：按访问会话隔离，检测操作实时
- 失败降级：检测失败时默认拒绝访问
- 可见性：记录权限决策与越权检测过程
- SLO：权限检测<30ms，误判率<0.1%

### 回放模块
- 职责：系统状态回放与场景重建，回放验证
- 输入：回放请求、时间区间、验证规则
- 输出：回放状态、重建场景、验证结果
- 状态：回放缓存、验证规则版本、回放历史
- 依赖：事件溯源、记忆索引与回放
- 并发：按回放会话隔离，回放操作幂等
- 失败降级：回放失败时跳过损坏时间段
- 可见性：记录回放过程与验证结果
- SLO：回放启动<500ms，回放准确率>99%

## 9) 基础设施

### 事件总线模块
- 职责：事件分发与路由，消息传递保证
- 输入：事件消息、路由规则、传递要求
- 输出：分发确认、传递状态、路由统计
- 状态：事件流、路由配置、传递统计
- 依赖：消息队列、所有业务模块
- 并发：按事件类型分片，至少一次传递
- 失败降级：传递失败时重试或进入死信队列
- 可见性：记录事件分发与传递过程
- SLO：事件分发<50ms，传递成功率>99.9%

### 队列系统模块
- 职责：消息队列管理与优先级控制，消息持久化
- 输入：队列消息、优先级标记、持久化请求
- 输出：队列确认、消息状态、持久化结果
- 状态：队列状态、优先级配置、持久化存储
- 依赖：事件总线、所有消费者模块
- 并发：按队列分片，消费操作有序
- 失败降级：队列故障时暂存本地后补传
- 可见性：记录队列操作与消息流转过程
- SLO：入队<10ms，出队<20ms，持久化>99.99%

### 对象存储模块
- 职责：大对象存储与版本管理，存储优化
- 输入：存储对象、版本标记、优化请求
- 输出：存储确认、版本信息、优化结果
- 状态：存储索引、版本管理、优化策略
- 依赖：所有需要大对象存储的模块
- 并发：按对象分片，存储操作幂等
- 失败降级：存储失败时多副本重试
- 可见性：记录对象存储与优化过程
- SLO：对象存储<500ms，可用性>99.99%

### 搜索与向量模块
- 职责：全文搜索与向量检索，搜索优化
- 输入：搜索请求、向量数据、优化配置
- 输出：搜索结果、向量匹配、优化报告
- 状态：搜索索引、向量库、优化策略
- 依赖：所有需要搜索功能的模块
- 并发：按搜索域隔离，搜索操作幂等
- 失败降级：搜索失败时降级为数据库查询
- 可见性：记录搜索过程与优化效果
- SLO：搜索响应<300ms，准确率>95%

### 空间引擎模块
- 职责：空间计算与遮挡判定，空间索引管理
- 输入：空间数据、计算请求、遮挡查询
- 输出：计算结果、遮挡判定、索引信息
- 状态：空间索引、计算缓存、遮挡规则
- 依赖：所有需要空间计算的模块
- 并发：按空间区域分片，计算操作幂等
- 失败降级：计算失败时使用简化算法
- 可见性：记录空间计算与遮挡判定过程
- SLO：空间计算<200ms，遮挡准确率>95%

### 时间调度器模块
- 职责：时间任务调度与时间管理，时间同步
- 输入：时间任务、调度规则、同步请求
- 输出：调度结果、时间状态、同步确认
- 状态：任务队列、调度配置、时间基准
- 依赖：所有需要时间服务的模块
- 并发：按时间域隔离，调度操作有序
- 失败降级：调度失败时重试或降级为即时执行
- 可见性：记录时间调度与同步过程
- SLO：任务调度<50ms，时间同步误差<10ms

## 端到端主路径与关键事件语义

### 路径A：用户交互驱动流程
1. 输入接收：用户请求接入，会话建立
2. 解析完成：信息分类拆分，实体关系识别
3. 实体解析完成：实体属性补全，关系图构建
4. 上下文构建完成：感知裁剪，记忆检索，上下文装配
5. 执行完成：场景/行为处理，状态变更
6. 判定触发：骰子判定，DM风格参数应用
7. 状态投影：状态机路由，状态持久化
8. 审计落账：审计日志记录，事件溯源存储
9. 回放快照：状态快照生成，回放点标记

### 路径B：时间驱动流程
1. 时间事件触发：时间调度器触发延迟行动
2. 上下文检索：记忆索引定位，相关上下文装配
3. 自动执行：场景/行为处理器自动执行
4. 状态更新：状态机路由更新相关状态
5. 事件传播：事件总线传播状态变更事件
6. 审计记录：审计模块记录自动执行过程
7. 回放标记：回放模块标记可回放状态点

## 并发与扩展单元

### 扩展单元划分
- 会话单元：按会话ID水平扩展，保证会话内有序
- 场景单元：按场景ID水平扩展，场景内状态一致性
- 角色单元：按角色ID水平扩展，角色状态隔离
- 组织单元：按组织ID水平扩展，组织内协调有序

### 并发控制策略
- 跨模块消息至少一次语义，关键链路幂等去重实现近似恰好一次
- 状态变更操作串行化，读操作并发优化
- 缓存一致性保证，最终一致与强一致结合
- 死锁检测与自动解除，优先级调度避免饥饿

## 质量与SLO对齐

### 延迟预算分配
- 接入与会话层：<100ms
- 路由与编排层：<300ms
- 解析与抽取层：<400ms
- 检索与上下文层：<500ms
- 执行层：<600ms
- 系统策略层：<100ms
- 数据与存储层：<200ms
- 观测与治理层：<50ms
- 基础设施：<50ms

### 吞吐量目标
- 支持10万+并发会话
- 每秒处理100万+事件
- 每秒完成50万+判定
- 每秒处理10万+空间计算

### Neo4j/JSONL映射责任
- 角色数据仓：角色实体与关系的主数据管理，版本化责任
- 世界数据仓：世界实体与拓扑关系的主数据管理，延迟版本化
- 剧情数据仓：事件节点与因果关系的主数据管理，时间边界责任
- 设定数据仓：规则节点与配置关系的主数据管理，版本兼容责任

### 关键约束体现
- 时间=记忆定位：记忆索引与回放模块实现时间轴定位
- 空间=行动判定/遮挡：空间引擎与感知裁剪器实现空间计算
- 规则/LLM混合：解析与抽取层实现规则与LLM混合策略
- 可重放：事件溯源与回放模块实现系统状态重放
- 10万+节点并发：分层架构与扩展单元设计支持大规模并发