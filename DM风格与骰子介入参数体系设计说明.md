# DM风格与骰子介入参数体系设计说明

## 1) 参数域与层级覆盖

- DMStyle 参数清单：难度/叙事密度/危机度/节奏/随机度权重/场外讨论容忍度/描写细度/公平性阈值。
- DicePolicy 参数清单：骰型(D20等)/优势劣势/重掷规则/暴击与大失败阈值/开放式掷骰/离散或连续映射。
- 覆盖层级：系统默认→设定域→会话→场景→角色；最近优先，显式覆盖；不可见域不得漂移到上下文。

## 2) 完备度—随机度函数族

- 函数族：线性反比/分段线性/Logistic/阈值门槛；参数由DMStyle.random_weight与Completeness驱动。
- Completeness 组成：上下文充分度/规则匹配置信/空间校验通过度/时间确定性；范围[0,1]。
- 输出 Randomness∈[0,1]；最小随机度由公平性阈值与难度门槛下限钳制；曲线版本入审计。

## 3) 触发与协同策略

- 三段式：规则≥阈值→确定；低置信→LLM补全；仍不足→DicePolicy判定；失败→模板降级。
- 触发点清单：解析冲突/别名歧义/关系不确定/空间边界模糊/规则缺口/行为代价对撞/长事务分歧。
- 固定种子：按会话+事件哈希派生；同输入同种子可重放；种子与温度入审计。

## 4) 注入路径与生效顺序

- 解析层：分类置信→LLM门槛→骰子补判；实体/关系歧义以DicePolicy裁决并标注来源。
- 路由层：Agent选择在随机度上界时倾向"稳健工具"策略；状态机在冲突迁移时用DicePolicy仲裁。
- 执行层：行为处理DC/代价/成功率受难度/危机度调制；场景处理遇边界条件以DicePolicy决策；时间驱动在冲突触发时参照节奏参数。
- 个体/群体处理：意图选择/强度/语言冗余受叙事密度/节奏影响；资源消耗概率受难度/危机度调制。

## 5) 参数到决策的映射

- 难度：提升DC、降低加值、提高失败代价；上限由公平性阈值限制。
- 叙事密度：增加事件频率/细节展开；约束总延迟SLO；对空间/时间校验不过度放宽。
- 危机度：提升遭遇率/环境压力；在低Completeness时抬高骰子权重。
- 节奏：控制时间驱动触发间隔与群体事件强度；限制长事务并行度。
- 随机度权重：放大随机度函数输出；但不突破可见性与规则硬约束。

## 6) DicePolicy 细则

- 判定类型：阈值检定/对抗检定/累进检定；支持优势/劣势与重掷上限；暴击/大失败可配置。
- 映射：检定值→成功等级（失败/部分成功/成功/卓越）；为行为处理器输出期望副作用区间。
- 公平性与反作弊：随机源可插拔；全链路审计；可公开掷骰摘要（可选）。

## 7) SLO、观测与审计

- SLO：骰子计算≤20ms、映射≤20ms、总额外预算≤80ms；DMStyle解析≤10ms。
- 指标：规则命中率/LLM调用率/骰子触发率/曲线版本分布/优势劣势比率/复现一致率。
- 审计：每次判定记录输入摘要/Completeness/曲线参数/种子/结果/替代路径；支持回放核对。

## 8) 越权与污染防护

- DMStyle/DicePolicy 的改变需权限；不可影响不可见域上下文；跨层传递只带派生结果与签名。
- 缓存隔离：不同DMStyle版本独立缓存键；上下文引用不复制敏感内容。

## 9) Neo4j/JSONL 映射原则（不写schema）

- 节点：DMStyle、DicePolicy、CompletenessProfile、DecisionEvent、CurveVersion、SeedDerivation。
- 关系：APPLIES_TO(→Actor/Scene/Session)、GOVERNS(→Action/Execution)、DERIVES_FROM、RECORDED_AT、VALID_DURING。
- 键：稳定业务键（scope+name+version）；事件携带valid_time/record_time；分块导入去重。

## 10) 质量门槛与验收

- 可重放一致率≥99.9%；越权拦截率100%；审计覆盖100%；SLO达标率P95≥99%。
- 提供开放问题清单（曲线默认参数、优势/劣势规则细节、公开掷骰策略、覆盖层级冲突优先级）。