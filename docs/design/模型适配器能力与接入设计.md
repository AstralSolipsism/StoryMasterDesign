# 模型适配器能力与接入设计

## 1. 设计目标与原则
- 一致接入：对上游模型与渠道进行抽象封装，提供统一调用与返回规范。
- 稳健可控：内建超时、重试、熔断、降级与回退链路；关键路径可观测、可审计。
- 策略驱动：以策略治理（AdapterPolicy）统一控制负载均衡与 key 轮询、失败策略与输出规范。
- 可选择性：基于能力标签与分组进行模型选择，满足“角色扮演、长上下文、逻辑能力、是否付费”等召回条件。
- 安全合规：敏感信息最小化处理，输出归一化与可见性策略兼容当前图谱映射。

## 2. 职责边界
- 向上承接：智能体路由、状态机路由、解析适配器、实体发掘、行为/个体处理对模型调用的统一入口。
- 向下封装：上游渠道（OpenAI、Anthropic 等）与具体模型端点；key 轮询与配额控制。
- 交付对象：标准化响应对象，保证字段稳定与错误语义可判定，便于执行层逻辑继续处理或回退。

## 3. 能力清单
- 连接与协议：HTTP(s) 与流式读取；请求构造与头部注入；幂等标识。
- 超时与重试：请求超时、连接超时；指数退避与抖动；幂等重试仅用于安全可重放操作。
- 熔断与降级：错误比例阈值触发熔断；半开探测；降级到备选端点/分组。
- 负载均衡与 key 轮询：按渠道维度做 key 轮询与配额守护，端点间加权分配。
- 选择策略：按标签（roleplay、long_context、reasoning、paid）与分组（RolePlay、LongContext）进行召回与优先级排序。
- 归一化输出：将上游响应规整为项目需要的字段结构（文本、工具调用结构、元数据、费用/时长等 telemetry）。
- 错误归一化：区分超时、限流、鉴权、服务错误、请求错误，出具稳定 error_code 与建议动作。
- 观测与审计：请求/响应摘要、延迟分位、失败原因、回退次数、召回命中标签与分组记录。
- 安全与合规：最小必要上下文注入；输出可见性与受众标注协同现有图谱字段。

## 4. 接口契约（摘要）
- 输入：模型选择条件（标签/分组/优先级）、提示或请求结构、超时/重试开关（可继承策略）。
- 输出：标准响应体（内容、附加结构、可见性建议、telemetry 指标、错误统一结构）。
- 语义：幂等请求要求可重放；非幂等场景禁止自动重试，仅返回错误并交由上层决策。

## 5. 策略项（AdapterPolicy）
- timeout_policy：开启/关闭；默认开启。
- retry_policy：exponential_backoff；最大尝试次数由部署配置指定。
- circuit_breaker：开启；半开探测与窗口由部署配置指定。
- key_rotation_strategy：round_robin。
- output_normalization：project_schema_v1。
- 选择偏好：优先分组与标签列表（例如 RolePlay、LongContext）。

## 6. 与系统模块关系
- 智能体路由、状态机路由：在需要模型辅助决策时经 ModelAdapter 调用。
- 解析适配器、实体发掘：对自由文本或结构化输入的模型处理统一走 ModelAdapter。
- 行为处理、个体处理：生成对话、心理或行动描述时经 ModelAdapter，遵循策略治理。
- 时间驱动、场景处理：不直接耦合，仅通过上层处理器间接使用。

## 7. 图谱映射（与本次追加对应）
- 模块：ModelAdapter（Architecture/Module）。
- 策略：ModelAdapterPolicy（Policy/AdapterPolicy）以 GOVERNS 作用于 ModelAdapter。
- 渠道：UpstreamChannel（OpenAI、Anthropic），ModelAdapter 以 ROUTES_TO 关联。
- 端点：ModelEndpoint（gpt-4o-mini、claude-3-5-haiku），由渠道 PROVIDES。
- 标签与分组：ModelTag（roleplay、long_context、reasoning、paid）与 ModelGroup（RolePlay、LongContext）；端点以 HAS_TAG 与 MEMBER_OF 关联。
- 备选回退：端点间 FALLBACKS_TO 绑定回退链路。

## 8. 兼容性与演进
- 与现有 JSONL 模式一致，字段遵循 valid_time/record_time/audience/visibility_scope。
- 后续可继续扩展：细化费用、时延分位、令牌消耗、策略数值化阈值等。

四、交付校验（由你在 attempt_completion 中输出）
- 节点新增 12 行，关系新增 24 行；更新后 nodes.jsonl=35 行、rels.jsonl=60 行。
- 新增 id 与既有 id 不冲突；引用闭包完整；时间/可见性字段齐备。
- 适配器与模块依赖、渠道与端点、标签与分组、回退链路均已图谱化。

五、完成后输出
- 使用 attempt_completion 汇报：
  1）已追加的节点与关系数量；2）两文件最新行数；3）关键新增 id 列表（至少包含 ModelAdapter、AdapterPolicy、两个 Channel、两个 Endpoint）；4）设计文档路径。