# 架构设计汇总 v1.0（评审稿）

- 版本：v1.0（锁定"预设D·叙事优先"）
- 日期：2025-11-03
- 范围：以跑团助手（多人+API）为目标的系统功能模块与程序架构设计；本稿为既有专题设计的汇编与评审依据。

参考原始专题设计：
- 设计原则：[系统设计原则与关键约束.md](系统设计原则与关键约束.md)
- 分层与边界：[系统分层与模块边界说明.md](系统分层与模块边界说明.md)
- 路由与解析：[智能体路由与状态机路由解析管线设计.md](智能体路由与状态机路由解析管线设计.md)
- 执行层模块：[执行层五模块详细设计说明.md](执行层五模块详细设计说明.md)
- 数据本体/版本/权限：[数据层本体与版本化权限策略设计说明.md](数据层本体与版本化权限策略设计说明.md)
- DM与骰子参数：[DM风格与骰子介入参数体系设计说明.md](DM风格与骰子介入参数体系设计说明.md)
- 并发与一致性：[并发模型与队列事务一致性策略设计说明.md](并发模型与队列事务一致性策略设计说明.md)
- 图谱映射规则：[Neo4j JSONL 模式与映射规则.md](Neo4j JSONL 模式与映射规则.md)
- 样例数据：节点 [samples/neo4j/architecture_nodes.jsonl](samples/neo4j/architecture_nodes.jsonl) ，关系 [samples/neo4j/architecture_rels.jsonl](samples/neo4j/architecture_rels.jsonl)

## 1. 设计目标与关键约束（摘录与固化）
- 可重放：固定随机种子、事件源与双时态（valid_time/record_time）。
- 统一时空：空间=行动与可见性判定；时间=行动用时与记忆定位锚点。
- 安全/剧透控制：基于 audience/visibility_scope 的多视图。
- 并发可线性化推理：按分片串行、跨分片幂等，支持回放再投影。
- 图谱首公民：架构关系可查询、可追溯、可视化。

## 2. 分层与模块边界（总览）
- Orchestration（编排层）
  - AgentRouter：为输入选择处理智能体/工具/模型。
  - StateMachineRouter：判定"故事内/外"与状态迁移。
- Execution（执行层，五模块）
  - 场景处理（SceneProcessor）：建立实体空间、方位与距离计算。
  - 行为处理（BehaviorProcessor）：规则匹配与分发（专项智能体/逻辑）。
  - 时间驱动（Time Engine）：行动用时累积、时间触发器。
  - 个体处理（Individual Processor）：按距离/逻辑/周期激活，基于角色卡生成交互。
  - 群体处理（Group Generator）：背景路人/组织/势力的动态生成。
- Data/Policy/Infra 层面详述见各专题文档链接。

## 3. 智能体路由 + 状态机路由与解析管线（数据流）
用户输入 → 状态机路由（故事内/外） → 若"故事内"，并行执行：
1) 信息类别拆分（描述行为/发言/心理/场外发言）→ 适配器处理；
2) 实体发掘（抽取实体）→ 适配器处理 + 图数据库检索算法；
→ 执行层五模块按规则与时间/空间判定推进。
详见：[智能体路由与状态机路由解析管线设计.md](智能体路由与状态机路由解析管线设计.md)

## 4. 数据层本体（四域）
- 角色域：人设/属性/物品/状态；玩家与NPC均有角色卡（触发条件）。
- 世界域：团体/组织/势力与其行动逻辑。
- 剧情域：伏笔（人物/动机）、主/支线、任务卡（角色概况/目标动机）。
- 设定域：规则书与通用设定。
- 时空与事件：Scene/Location/LosSegment、时间节点、ParsingEvent/DecisionEvent/StateTransition/MemoryAnchor。
详见：[数据层本体与版本化权限策略设计说明.md](数据层本体与版本化权限策略设计说明.md)

## 5. 策略预设（锁定：预设D·叙事优先）
- 随机度：0.1；骰子：StandardD20（仅在争议判定调用）。
- 时间粒度：5s tick；图谱时间索引：minute bucket 对齐。
- 空间近似：L1（包围体+简化遮挡，按需LOS）。
- 并发一致性：按场景分片 8，至少一次投递语义（Outbox+去重键）。
- 可见性：DM策展揭示优先（读时过滤为主，必要时写时复制）。
- 影响与权衡：
  - 性能优先于高频物理拟真；回放性强；叙事节奏与DM控制权更大。
  - 高并发场景依赖幂等与补偿；空间判定采用延迟/批处理以控成本。
详见：[DM风格与骰子介入参数体系设计说明.md](DM风格与骰子介入参数体系设计说明.md)

## 6. 并发与事务一致性（执行准则）
- 分片：按 Scene 分片（8 shards 默认），分片内单线程邮箱；跨分片事件带幂等键。
- 投递语义：至少一次；Outbox/Saga；去重表与死信队列（DLQ）。
- 回放：事件源→再投影；双时态校验；固定随机种子确保可复现。
详见：[并发模型与队列事务一致性策略设计说明.md](并发模型与队列事务一致性策略设计说明.md)

## 7. Neo4j JSONL 映射（架构→图）
- 节点标签族：Architecture/Layer/Module、Data/Actor/Scene/Location/Spatial、Policy/DMStyle/DicePolicy、Event/ParsingEvent/DecisionEvent/StateTransition、Temporal/TimeNode/MemoryAnchor。
- 关系类型：CONTAINS/DEPENDS_ON/APPLIES_TO/GOVERNS/LOCATED_IN/COVERED_BY/HAS_LOS_TO/EMITS/CAUSAL/OCCURS_AT/RECORDED_AT/PERTAINS_TO/REMEMBERS。
- 键与时态：稳定 id；props.valid_time/record_time；可见性 audience/visibility_scope。
- 校准样例：节点 [samples/neo4j/architecture_nodes.jsonl](samples/neo4j/architecture_nodes.jsonl) ，关系 [samples/neo4j/architecture_rels.jsonl](samples/neo4j/architecture_rels.jsonl)
详见：[Neo4j JSONL 模式与映射规则.md](Neo4j JSONL 模式与映射规则.md)

## 8. 质量门槛与SLO（评审基线）
- 正确性：引用完整、幂等键可回放；时态连续/无交叉。
- 性能：5s tick 下单场景 ~数百实体可实时；跨场景延迟 P95 ≤ 1s。
- 可见性：剧透等级0默认；DM可提升揭示等级；玩家仅 own/party 可见。
- 审计：事件链（解析→路由→迁移→记忆锚点）可追溯。

## 9. 开放问题与取舍（待迭代）
- 自适应 tick 的振荡控制与观测。
- L1 空间近似下的部件穿模判定边界与缓存策略。
- 任务卡驱动的剧情节点版本化与多视图同步。

## 10. 下一步：生成"完整系统设计"的图谱
- 目标：产出"完整系统设计"的 Neo4j JSONL（不仅是最小样例），覆盖所有层/模块/策略/数据本体与关键事件流。
- 建议输出：`full_architecture_nodes.jsonl` 与 `full_architecture_rels.jsonl`（分块导出）。
- 质量检查：稳定键唯一、时态/可见性齐备、引用闭包、导入预检通过。

—— 评审稿结束 ——