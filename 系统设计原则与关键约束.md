# 系统设计原则与关键约束

1.  **架构价值取向**
    *   **正确性优先**：核心状态强一致，非关键路径最终一致；状态变更必须可溯源
    *   **可观测性优先**：所有决策路径必须记录审计日志；关键事件支持事件溯源与记忆回放
    *   **可演进性**：模块间松耦合，策略可配置化替换；核心接口版本化兼容

2.  **模块化边界与职责抽象**
    *   **智能体路由**：负责意图分发与上下文聚合；状态机路由负责状态转换与事件触发；两者容错时降级为确定性规则
    *   **解析与抽取**：规则处理确定性逻辑，LLM处理不确定性；混合策略可配置权重；结果必须可重放与缓存
    *   **执行层五类处理**：场景驱动最高优先级，行为驱动次之；每类处理保证幂等；失败时自动补偿
    *   **数据层**：角色数据实时版本化，世界数据延迟版本化；权限按玩家/NPC/系统三级隔离；ID全局唯一且稳定
    *   **系统层**：骰子参数与DM风格参数必须显式进入决策路径；随机源可插拔；测试环境支持固定种子

3.  **时间与空间的统一语义**
    *   **时间轴**：事件时间优先于系统时间；冲突按时间戳+优先级解决；长事务支持延迟行动；记忆定位按时间区间索引
    *   **空间**：三维坐标与拓扑关系互操作；距离/范围/施法模板可配置；视线/弹道遮挡分级计算；感知视域严格裁剪

4.  **上下文与可见性控制**
    *   **角色视域**：按感知范围分层；玩家仅见己方信息，NPC仅见感知范围内信息，系统信息需权限
    *   **LLM上下文**：仅包含可见数据；隐私信息严格裁剪；使用引用型上下文减少数据复制；记忆引用按时间窗裁剪
    *   **知识注入**：必须验证来源；缓存隔离防污染；回放校验防篡改；越权访问自动阻断

5.  **判定与随机策略**
    *   **完备度-随机度函数**：完备度越高随机度越低；函数曲线可配置；默认为反比例关系
    *   **骰子**：仅在不确定性不可消解时触发；触发点必须记录原因与替代方案
    *   **DM风格参数化**：难度门槛影响成功率；叙事密度影响事件频率；危机度影响资源消耗
    *   **可重放性**：固定种子保证确定性；关键决策支持录制-回放；测试环境优先确定性模拟

6.  **并发、队列、事务**
    *   **Actor/Agent间消息**：至少一次语义；关键操作实现恰好一次；消息去重基于业务ID
    *   **跨模块事务**：优先事件源化+读模型投影；直接更新仅限低频高一致性需求场景
    *   **幂等键**：基于操作ID+时间戳；重试指数退避；补偿操作自动生成；死信队列人工审核

7.  **Neo4j/JSONL对齐的图谱设计原则**
    *   **多标签策略**：模块标签+层级标签+实体类型标签+版本状态标签；标签组合唯一标识节点类型
    *   **版本化**：valid\_time表示数据有效期，record\_time表示记录时间；记忆事件有时间边界
    *   **事件节点一等公民**：Event节点通过CAUSAL/EMITS/DERIVES关系连接实体；事件不可变更
    *   **导入策略**：JSONL分块导入；稳定键保证去重；批量操作支持事务回滚
    *   **映射一致性**：单一事实主存在Neo4j；其他系统仅保留引用；定期同步校验

8.  **性能与容量目标**
    *   **延迟SLO**：交互回合总响应<3秒；LLM调用<2秒；规则判定<500ms；空间计算<200ms
    *   **存储基线**：节点平均出入度<10；热点数据缓存；读写比1:5；时间/空间索引全覆盖
    *   **10万+节点分层**：热数据(7天)内存缓存；温数据(30天)SSD存储；冷数据(>30天)归档

9.  **质量门槛与验收标准**
    *   **架构一致性检查**：模块依赖无环；接口契约明确；数据流向可追踪；状态转换完备
    *   **可观测性最小集合**：关键业务指标；完整错误日志；请求全链路追踪；事件时间线重建
    *   **安全最小集合**：感知隔离测试；越权访问测试；数据加密传输；敏感操作审计

10. **开放问题清单**
    *   空间遮挡近似等级默认值需用户决策；施法模板库粒度需明确；记忆保留策略需定义
    *   骰子介入度与完备度函数曲线需具体参数；DM风格参数权重需用户配置
    *   事件溯源保留周期需确定；跨模块事务补偿策略需细化；并发冲突解决优先级需明确
