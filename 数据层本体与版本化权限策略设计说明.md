# 数据层本体与版本化/权限策略设计说明

## 1) 本体顶层域与范围

- 域：角色（Actor/Player/NPC）、世界（Scene/Location/Organization/Item）、剧情（Quest/Goal/Event/ActionPlan/Execution/MemoryAnchor/TimeNode）、设定（Rule/Ability/Spell/Setting/Lore/Condition/Effect/Resource/DMStyle/DicePolicy）
- 范围：仅项目功能/程序架构图谱，不含具体故事内容；事件源化与投影并存
- 时间=记忆定位（事件/区间索引）：TimeNode/MemoryAnchor作为时间锚点，支持事件区间引用与回放
- 空间=行动判定/遮挡（范围/视线/弹道/掩体/可达性）：Location/PathNode/CoverCell/LosSegment参与空间计算

## 2) 节点类型清单（逐类给"定义/身份/版本/可见性/主存"原则）

### 角色类
- Actor：定义角色基础实体，身份全局稳定ID，版本实时更新，可见性按角色类型，主存数据
- Player(Actor)：定义玩家角色，身份继承Actor，版本实时更新，可见性仅自身，主存数据
- NPC(Actor)：定义非玩家角色，身份继承Actor，版本实时更新，可见性按感知范围，主存数据
- Party：定义队伍组织，身份全局稳定ID，版本实时更新，可见性队员共享，主存数据
- PerceptionProfile：定义感知配置，身份绑定Actor，版本可配置，可见性系统级，引用数据
- Inventory：定义物品清单，身份绑定Actor，版本实时更新，可见性仅所有者，主存数据
- Status：定义状态效果，身份绑定Actor，版本带有效期，可见性所有者可见，主存数据
- Trait：定义角色特性，身份绑定Actor，版本稳定，可见性按权限，引用数据

### 世界类
- Scene：定义场景容器，身份全局稳定ID，版本延迟更新，可见性全域，主存数据
- Location(拓扑/房间)：定义位置节点，身份全局稳定ID，版本稳定，可见性全域，主存数据
- PathNode：定义路径节点，身份绑定Scene，版本稳定，可见性全域，引用数据
- CoverCell：定义掩体单元，身份绑定Scene，版本稳定，可见性全域，引用数据
- LosSegment：定义视线段，身份绑定Scene，版本稳定，可见性全域，引用数据
- Organization：定义组织实体，身份全局稳定ID，版本延迟更新，可见性成员可见，主存数据
- Faction：定义势力关系，身份全局稳定ID，版本稳定，可见性全域，引用数据
- Item：定义物品实体，身份全局稳定ID，版本稳定，可见性按持有者，主存数据
- Container：定义容器实体，身份继承Item，版本实时更新，可见性按持有者，主存数据

### 剧情类
- Quest：定义任务主线，身份全局稳定ID，版本带状态，可见性参与者，主存数据
- Task：定义任务子项，身份绑定Quest，版本带状态，可见性参与者，主存数据
- Goal：定义目标节点，身份全局稳定ID，版本带状态，可见性参与者，主存数据
- Clue：定义线索信息，身份全局稳定ID，版本稳定，可见性按发现者，主存数据
- Foreshadow：定义伏笔信息，身份全局稳定ID，版本稳定，可见性系统级，主存数据
- Event(不可变)：定义事件记录，身份全局稳定ID，版本不可变，可见性按权限，主存数据
- ActionPlan：定义行动计划，身份绑定Actor，版本带状态，可见性执行者，主存数据
- Execution：定义执行记录，身份绑定ActionPlan，版本不可变，可见性执行者，主存数据
- MemoryAnchor：定义记忆锚点，身份全局稳定ID，版本不可变，可见性按权限，主存数据
- TimeNode：定义时间节点，身份全局稳定ID，版本不可变，可见性全域，主存数据
- Trigger：定义触发器，身份绑定Event，版本可配置，可见性系统级，引用数据

### 设定类
- Rule：定义规则节点，身份全局稳定ID，版本草稿/发布，可见性系统级，主存数据
- Ability/Spell：定义能力/法术，身份全局稳定ID，版本草稿/发布，可见性按权限，主存数据
- Condition：定义条件节点，身份全局稳定ID，版本稳定，可见性系统级，引用数据
- Effect(Buff/Debuff)：定义效果节点，身份全局稳定ID，版本稳定，可见性按目标，主存数据
- Resource：定义资源节点，身份全局稳定ID，版本稳定，可见性按持有者，主存数据
- DMStyle：定义DM风格，身份全局稳定ID，版本可配置，可见性系统级，主存数据
- DicePolicy：定义骰子策略，身份全局稳定ID，版本可配置，可见性系统级，主存数据
- Template：定义模板节点，身份全局稳定ID，版本草稿/发布，可见性按权限，主存数据

### 横切类
- Knowledge：定义知识节点，身份全局稳定ID，版本带有效期，可见性按权限，主存数据
- VisibilitySlice：定义可见性切片，身份绑定Actor，版本实时更新，可见性系统级，引用数据
- ContextSnapshot：定义上下文快照，身份绑定会话，版本不可变，可见性会话级，引用数据
- VersionMarker：定义版本标记，身份绑定实体，版本不可变，可见性系统级，引用数据
- AuditRecord：定义审计记录，身份全局稳定ID，版本不可变，可见性审计员，主存数据

## 3) 关系类型清单（逐类给"方向/基数/版本/可见性"原则）

### 结构关系
- BELONGS_TO：方向Actor→Organization，基数N:1，版本实时更新，可见性成员可见
- MEMBER_OF：方向Organization→Actor，基数1:N，版本实时更新，可见性成员可见
- OWNS/CONTAINS：方向Actor→Item，基数1:N，版本实时更新，可见性所有者可见
- LOCATED_IN/OCCURS_IN_SCENE：方向Actor/Event→Scene，基数N:1，版本实时更新，可见性全域
- NEAR/NAV_TO/PATH_TO：方向Location→Location，基数N:N，版本稳定，可见性全域
- COVERED_BY/BLOCKED_BY：方向Actor→CoverCell，基数N:1，版本实时更新，可见性全域
- HAS_LOS_TO：方向Actor→Actor/Location，基数N:N，版本实时更新，可见性感知范围内

### 行为关系
- INTENDS(Action)→EXECUTES：方向Actor→Execution，基数1:N，版本实时更新，可见性执行者可见
- AFFECTS：方向Execution→Actor/Item，基数N:N，版本不可变，可见性影响者可见
- CONSUMES(Resource)：方向Execution→Resource，基数N:N，版本不可变，可见性执行者可见
- GAINS/LOSES(Status/Item)：方向Actor→Status/Item，基数N:N，版本实时更新，可见性所有者可见
- TARGETS：方向Execution→Actor/Location，基数N:1，版本不可变，可见性执行者可见

### 时间关系
- OCCURS_AT(TimeNode)：方向Event→TimeNode，基数N:1，版本不可变，可见性按权限
- VALID_DURING(valid_time)：方向实体→时间区间，基数N:1，版本带有效期，可见性按实体
- RECORDED_AT(record_time)：方向实体→时间点，基数1:1，版本不可变，可见性系统级
- NEXT/PREV(Event)：方向Event→Event，基数1:1，版本不可变，可见性按权限
- SCHEDULED_AT：方向Execution→TimeNode，基数N:1，版本实时更新，可见性执行者可见

### 知识与可见性关系
- REFS_VISIBLE：方向ContextSnapshot→实体，基数N:N，版本实时更新，可见性会话级
- PERCEIVES：方向Actor→实体，基数N:N，版本实时更新，可见性感知范围内
- REMEMBERS(MemoryAnchor)：方向Actor→MemoryAnchor，基数N:N，版本不可变，可见性所有者可见
- DERIVES/CAUSAL/EMITS：方向Event→Event，基数N:N，版本不可变，可见性按权限
- HINTS/FORESHADOWS：方向Clue→Foreshadow，基数N:N，版本稳定，可见性系统级

### 设定关系
- ALLOWS/BANs(Condition↔Rule)：方向Condition↔Rule，基数N:N，版本草稿/发布，可见性系统级
- APPLIES(Effect↔Actor/Execution)：方向Effect→Actor/Execution，基数N:N，版本实时更新，可见性目标可见
- REQUIRES(Ability↔Resource)：方向Ability→Resource，基数N:N，版本草稿/发布，可见性系统级

## 4) 跨域机制与上下文构建

- 主存—引用：事实唯一主存（世界/设定/事件），上下文仅持引用（ID+版本态+可见标签）
- 可见性裁剪：按视域/遮挡/范围与记忆时间窗构建VisibilitySlice；禁止越权穿透
- 时间=记忆定位：MemoryAnchor/TimeNode作为时间锚点，支持事件区间引用与回放
- 空间=行动判定：Location/PathNode/CoverCell/LosSegment参与可达性/遮挡/射程计算
- 上下文装配：引用型上下文仅包含ID与必要片段，避免大块文本复制
- 跨域引用：通过稳定ID实现跨域引用，版本态确保引用一致性
- 污染隔离：不同角色的上下文缓存隔离，防止数据污染

## 5) 版本化与时态（双时态）

- 节点/关系均携带valid_time（世界内有效期）与record_time（系统记录时间）
- Event/MemoryAnchor不可变：一旦创建不可修改，仅能追加新事件
- 草稿/发布：设定与世界建模支持草稿/审校/发布态；剧情与事件仅增不改
- 时间=记忆定位：valid_time用于世界内时间定位，record_time用于系统审计
- 版本链：通过VersionMarker节点构建版本链，支持版本追溯
- 事件追加：以事件追加表示变更，保持历史完整性
- 时态查询：支持按valid_time和record_time的双时态查询

## 6) 权限与可见性模型（RBAC+ABAC）

- 角色：Player/NPC/System三层；策略：基于域与标签（visibility_scope、audience、spoiler_level）
- 可见性规则：仅玩家自身感知与队伍共享；NPC仅视域内；系统全域但需审计
- 上下文构建默认最小必要：仅包含执行所需的最小数据集
- RBAC基础：基于角色的基础权限控制，定义角色可访问的数据域
- ABAC扩展：基于属性的细粒度控制，考虑时间、空间、状态等上下文属性
- 越权拦截：检测到越权访问立即拒绝并记录审计日志
- 动态权限：权限随角色状态、位置、时间动态调整

## 7) 身份与键稳定性

- 全局稳定ID：type:namespace:ulid（例actor:game1:...）；保证全局唯一性
- 关系去重键：sourceID+relType+targetID+version态；确保关系唯一性
- 业务幂等键：会话ID+序号+内容哈希；支持操作幂等性
- Event/Execution基于业务键+版本态去重：确保事件和执行记录唯一性
- ID命名空间：按域划分命名空间，避免ID冲突
- 版本态标识：通过版本态标识区分同一实体的不同版本
- 引用完整性：通过稳定ID保证跨域引用的完整性

## 8) 索引与约束

- 唯一约束：stable_id唯一；确保实体唯一性
- 组合索引：label+stable_id；优化标签查询性能
- 时间/空间索引：valid_time、record_time、scene_id+cell/coord；支持时空查询
- 可见性与热数据索引：audience/visibility_scope、recent(valid_time within N)；优化可见性查询
- 关系索引：sourceID+relType+targetID；优化关系遍历
- 复合索引：按查询模式设计复合索引，提高查询效率
- 分区索引：按时间/空间分区建立索引，支持大规模数据

## 9) 生命周期与分层存储

- 分层：热(7天)/温(30天)/冷(历史)；按访问频率分层存储
- MemoryAnchor/事件时间线可归档但保索引；归档后保留索引信息
- 归纳/聚合：定期将长期历史压缩为摘要节点并保原事件引用
- 数据迁移：热数据自动迁移到温层，温数据定期迁移到冷层
- 生命周期策略：根据数据类型制定不同的生命周期策略
- 存储优化：冷数据采用压缩存储，降低存储成本
- 查询路由：根据数据分层路由查询，优化查询性能

## 10) 事务、一致性与并发

- 事件源化优先：写入路径=追加Event+更新投影（最终一致）
- 关键状态投影采用事务提交：保证关键状态强一致性
- 分片：按会话/场景/组织；跨分片通过Event总线
- 至少一次消息+幂等去重：确保消息可靠传递
- 冲突解决：时间优先级+事件时间戳解决冲突
- 分布式事务：跨分片操作采用分布式事务保证一致性
- 补偿机制：失败操作自动生成补偿事务

## 11) 空间与时间集成约束

- 空间：Location/PathNode/CoverCell/LosSegment参与可达性/遮挡/射程
- 关系NAV_TO/PATH_TO/COVERED_BY/HAS_LOS_TO：定义空间关系
- 时间：TimeNode/MemoryAnchor/valid_time严格约束回放与记忆定位
- 长事务用区间边界标注：长事务使用时间区间边界标注
- 时空联动：空间变更触发时间事件，时间推进影响空间状态
- 空间索引：按场景分区建立空间索引，优化空间查询
- 时间索引：按时间轴建立索引，支持快速时间定位

## 12) Neo4j JSONL 映射原则（不写schema）

- 标签策略：域标签+实体类型+版本态；事件为一等公民
- 关系带有效期与记录期：所有关系携带valid_time和record_time
- 导入：JSONL分块、稳定键去重、幂等可重放
- 同一事实唯一主存，其余节点/上下文均做引用
- 映射一致性：Neo4j中的数据结构与本体定义保持一致
- 批量操作：支持批量导入和批量更新，提高导入效率
- 错误处理：导入错误时提供详细错误信息，支持部分重试

## 13) 查询模式与SLO（用于后续优化）

- 上下文装配查询：可见实体+可见关系+最近记忆锚点，预算<200ms
- 走复合索引：优化上下文装配查询性能
- 空间裁剪查询：按scene+cell/coord+LOS；预算<200ms
- 失败降级到近似层级：空间查询失败时降级到近似层级
- 时间范围查询：按valid_time和record_time查询历史数据
- 可见性过滤查询：按角色权限过滤可见数据
- 路径查询：基于NAV_TO/PATH_TO关系的路径查询

## 14) 可观测性与审计

- 审计：所有写入附AuditRecord与事件时间线；变更可回放与校验
- 指标：查询延迟分位、索引命中率、去重率、越权拦截计数、归档压缩比
- 全链路追踪：记录数据操作的全链路信息
- 性能监控：实时监控查询性能和系统负载
- 异常检测：自动检测异常操作和性能问题
- 报表生成：定期生成审计报表和性能报表
- 告警机制：异常情况自动告警，及时响应问题

## 15) 开放问题清单

- 设定库粒度与版本策略：设定库的粒度划分和版本管理策略需进一步明确
- 空间近似等级默认与切换阈值：空间近似等级的默认值和切换阈值需用户决策
- 记忆保留与摘要窗口参数：记忆保留时间和摘要窗口参数需具体定义
- 多租户隔离域名空间：多租户环境下的域名空间隔离策略需细化
- 跨会话共享设定的同步模型：跨会话共享设定数据的同步模型需设计
- 归档后回放的精度等级：归档数据回放的精度等级和性能权衡需确定
- 权限策略的动态更新机制：权限策略动态更新的机制和一致性保证需设计
- 大规模并发下的性能优化策略：10万+节点并发下的性能优化策略需细化